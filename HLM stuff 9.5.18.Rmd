---
title: "HLM stuff"
output: html_document
---

```{r message=FALSE, warning=FALSE}
#load("~/Desktop/hmiout40")
load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity_new/hmifall2018_m10_better")


library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
```

Creating mitml and extra variables
```{r}
MIdata<-mids2mitml.list(hmi.fall.2018) #converts file type

thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  class_means$class_pre_cent <- class_means$pre_mean_class - mean(class_means$pre_mean_class)
  temp <- left_join(temp,class_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- temp$colab_no_la + temp$used_las
  #assign(df.names[i], temp)
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)
```


Models
```{r}
mod_1<-with(MIdata,{lmer(gain~1 + (1|course_id))})
mod_2<-with(MIdata,{lmer(gain~1 + class_pre_cent + (1|course_id))})
mod_3<-with(MIdata,{lmer(gain~1 + stud_pre_cent + (1|course_id))})
mod_4<-with(MIdata,{lmer(gain~1 + stud_pre_cent + coll + (1|course_id))})
mod_5<-with(MIdata,{lmer(gain~1 + stud_pre_cent + colab_no_la + used_las + (1|course_id))})
mod_6<-with(MIdata,{lmer(gain~1 + stud_pre_cent  + colab_no_la + la_in_lab + la_in_lecture + la_in_rec + (1|course_id))})
mod_7<-with(MIdata,{lmer(gain~1 + stud_pre_cent  + colab_no_la + la_in_lab + la_in_lecture + la_in_rec + (1 + stud_pre_cent|course_id))})
mod_8<-with(MIdata,{lmer(gain~1 + stud_pre_cent  + colab_no_la + used_las + (1 + stud_pre_cent|course_id))})
#full model
```
#average student posttest score is 54.59

```{r}
testEstimates(mod_1, var.comp=TRUE)
testEstimates(mod_2, var.comp=TRUE)
testEstimates(mod_3, var.comp=TRUE)
testEstimates(mod_4, var.comp=TRUE)
testEstimates(mod_5, var.comp=TRUE)
testEstimates(mod_6, var.comp=TRUE) #best model
testEstimates(mod_7, var.comp=TRUE)
testEstimates(mod_8, var.comp=TRUE)

```

This makes a table for the model development. Two sections need to be modified. The models and the equation column.
```{r}
models <- c("mod_1","mod_2","mod_3","mod_4","mod_5","mod_6","mod_7")

mod_var_tab <- data_frame(model = NA,
                          level2 = NA,
                          level1 = NA,
                          ICC = NA)

for(i in 1:7){
  temp <- testEstimates(get(models[i]), var.comp=TRUE)
  mod_var_tab[i,1] <- models[i]
  mod_var_tab[i,2] <- temp$var.comp[1]
  mod_var_tab[i,3] <- temp$var.comp[2]
  mod_var_tab[i,4] <- temp$var.comp[3]
  }

mod_var_tab$lvl1change <- (mod_var_tab$level1[1]- mod_var_tab$level1)/mod_var_tab$level1[1]
mod_var_tab$lvl2change <- (mod_var_tab$level2[1]- mod_var_tab$level2)/mod_var_tab$level2[1]

mod_var_tab$equation <- c("gain~1 + (1|course_id)","gain~1 + stud_pre_cent + (1|course_id)","gain~1 + stud_pre_cent + class_pre_cent + (1|course_id)","gain~1 + stud_pre_cent + race_URM + gend_URM + (1|course_id)","gain~1 + stud_pre_cent + race_URM*gend_URM + (1|course_id)","gain~1 + race_URM + gend_URM + stud_pre_cent + coll + (1|course_id)","gain~1 +race_URM*coll + gend_URM*coll+ stud_pre_cent + (1|course_id)")
```

This produces the estimates for mod_6
```{r}
TL = c(1,0,0,0,0,0)
CL = c(1,1,0,0,0,0)
LALec = c(1,0,0,0,1,0)
LARec = c(1,0,0,0,0,1)
LALab = c(1,0,0,1,0,0)


contrast_forms_mod6 <- rbind('Traditional Lecture'=TL, 'Collaborative Learning'=CL, 
                          'LA in Lecture'=LALec, 'LA in Recitation'=LARec, 
                          'LA in Lab'=LALab)
```

```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 

return <- p3est}
```

```{r}
contrast_g6_est <- pool_and_cov_diffwm(gain6,contrast_forms_mod6)

contrast_g6_est$instruction <- factor(contrast_g6_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g6_est, aes(x=instruction, y=Q, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  facet_grid(.~race_gender, scales = "free", space = "free")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) 

kable(contrast_g6_est[c(1,2,6,7)], digits = 2)
```

#Assumption checking

```{r}
	for (i in 1:10) {
  D1 <- lmer(mod6,data=MIdata[[i]])
  print(plot(D1, xlab="Fitted Value", ylab="Residual Variance"))
}
 

for (i in 1:10) {
  D1 <- lmer(mod6,data=MIdata[[i]])
#visual homogeneity of variance
MIdata[[i]]$Model.F.Res <- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[i]]$Abs.Model.F.Res <-abs(MIdata[[1]]$Model.F.Res) #creates a new column with the absolute value of the residuals
print(boxplot(MIdata[[i]]$Model.F.Res ~ MIdata[[i]]$course_id, xlab = "Course", ylab = "Residuals" ))
}

for (i in 1:10) {
  D1 <- lmer(mod6,data=MIdata[[i]])
#Assumption of Normality or residuals: want points to be near the line
print(qqmath(D1))
}
```
 # This produces a table of the pvalues for the correlations between the student level variables for pretest and the residuals. These p values should be large to indicate that there isn't a correlation
```{r}
res_corr <- data_frame(it =NA,
                       with_pre_score = NA,
                       with_cent_pre = NA)
 for (i in 1:10) {
res_corr[i,1] <- i
D1 <- lmer(mod6,data=MIdata[[i]])
temp <- cor.test(resid(D1), MIdata[[i]]$pre_score)
res_corr[i,2] <-  temp$p.value 
temp <-  cor.test(resid(D1), MIdata[[i]]$stud_pre_cent)
res_corr[i,3] <- temp$p.value
}
```	

```{r}
lev_p <- data_frame(it =NA,
                       p_values = NA)
 for (i in 1:10) {
lev_p[i,1] <-i
D1 <- lmer(mod6,data=MIdata[[i]])
MIdata[[i]]$Model.F.Res<- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[i]]$Abs.Model.F.Res <-abs(MIdata[[i]]$Model.F.Res) #creates a new column with the absolute value of the residuals
Levene.Model.F <- lm(Model.F.Res ~ course_id, data=MIdata[[i]]) #ANOVA of the residuals
temp <-anova(Levene.Model.F) #displays the results: want a p>0.05
lev_p[i,2] <- temp$`Pr(>F)`[[1]]
}
```

